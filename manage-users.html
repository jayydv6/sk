<!-- Add these new features to your existing manage-users.html file -->

<!-- Add these sections before the closing </main> tag in manage-users.html -->

<!-- Premium Upgrade Section -->
<div class="dashboard-card">
    <h3><i class="fas fa-crown"></i> PREMIUM UPGRADE</h3>
    <div style="margin-top: 15px;">
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <input type="text" id="upgrade-username" class="form-control" placeholder="Enter username to upgrade" style="flex: 1;">
            <select id="upgrade-plan" class="form-control" style="width: 150px;">
                <option value="1month">1 Month - ₹1000</option>
                <option value="3months">3 Months - ₹2500</option>
                <option value="6months">6 Months - ₹4500</option>
                <option value="1year">1 Year - ₹8000</option>
            </select>
            <button class="btn btn-premium" onclick="upgradeToPremium()">
                <i class="fas fa-crown"></i> Upgrade to Premium
            </button>
        </div>
        <div id="upgrade-status"></div>
    </div>
</div>

<!-- Guesser Ratings Management -->
<div class="dashboard-card">
    <h3><i class="fas fa-star"></i> MANAGE GUESSER RATINGS</h3>
    <div class="ratings-management" id="ratings-management">
        <!-- Guesser ratings will be loaded here -->
    </div>
    <div style="margin-top: 15px;">
        <button class="btn btn-info" onclick="calculateAllRatings()">
            <i class="fas fa-calculator"></i> Calculate All Ratings
        </button>
        <button class="btn btn-outline" onclick="resetAllRatings()">
            <i class="fas fa-redo"></i> Reset All Ratings
        </button>
    </div>
</div>

<!-- Add this JavaScript to your manage-users.html script section -->

// Premium upgrade function
function upgradeToPremium() {
    const username = document.getElementById('upgrade-username').value.trim();
    const plan = document.getElementById('upgrade-plan').value;
    
    if (!username) {
        alert('Please enter a username!');
        return;
    }
    
    let users = JSON.parse(localStorage.getItem('matkaUsers') || '[]');
    const user = users.find(u => u.username === username);
    
    if (!user) {
        alert('User not found!');
        return;
    }
    
    if (user.type === 'premium') {
        alert('User is already premium!');
        return;
    }
    
    // Calculate expiry date based on plan
    const expiryDate = new Date();
    switch(plan) {
        case '1month':
            expiryDate.setMonth(expiryDate.getMonth() + 1);
            break;
        case '3months':
            expiryDate.setMonth(expiryDate.getMonth() + 3);
            break;
        case '6months':
            expiryDate.setMonth(expiryDate.getMonth() + 6);
            break;
        case '1year':
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            break;
    }
    
    // Upgrade user to premium
    user.type = 'premium';
    user.expiryDate = expiryDate.toISOString().split('T')[0];
    user.upgradedOn = new Date().toISOString().split('T')[0];
    user.upgradedBy = JSON.parse(localStorage.getItem('currentUser') || '{}').username || 'admin';
    
    localStorage.setItem('matkaUsers', JSON.stringify(users));
    
    document.getElementById('upgrade-status').innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            ${username} upgraded to premium until ${user.expiryDate}
        </div>
    `;
    
    document.getElementById('upgrade-username').value = '';
    loadUsers();
    updateStatistics();
    
    logActivity(`Upgraded ${username} to premium (${plan})`);
}

// Load guesser ratings
function loadGuesserRatings() {
    const users = JSON.parse(localStorage.getItem('matkaUsers') || '[]');
    const guessers = users.filter(u => u.type === 'guesser');
    const predictions = JSON.parse(localStorage.getItem('matkaPredictions') || '[]');
    
    const container = document.getElementById('ratings-management');
    
    if (guessers.length === 0) {
        container.innerHTML = '<p style="color: #a0a0c0; text-align: center; padding: 20px;">No guessers found</p>';
        return;
    }
    
    let html = '';
    guessers.forEach(guesser => {
        // Calculate guesser stats
        const guesserPredictions = predictions.filter(p => 
            p.guesserId === guesser.id || p.guesserId === guesser.username
        );
        
        const total = guesserPredictions.length;
        const correct = guesserPredictions.filter(p => p.isCorrect === true).length;
        const pending = guesserPredictions.filter(p => p.isCorrect === undefined).length;
        const checked = total - pending;
        const accuracy = checked > 0 ? Math.round((correct / checked) * 100) : 0;
        
        // Calculate rating (1-5 stars based on accuracy)
        let rating = guesser.rating || 0;
        if (!guesser.rating) {
            if (checked >= 10) {
                if (accuracy >= 90) rating = 5;
                else if (accuracy >= 80) rating = 4;
                else if (accuracy >= 70) rating = 3;
                else if (accuracy >= 60) rating = 2;
                else rating = 1;
            }
        }
        
        html += `
            <div class="guesser-rating-card">
                <h4>${guesser.name || guesser.username}</h4>
                <div class="rating-stars">
                    ${'★'.repeat(rating)}${'☆'.repeat(5 - rating)}
                </div>
                <div style="font-size: 0.9rem; color: #a0a0c0;">
                    Accuracy: ${accuracy}% (${correct}/${checked})
                </div>
                <div style="font-size: 0.9rem; color: #a0a0c0;">
                    Total Predictions: ${total}
                </div>
                <div class="rating-controls">
                    <select class="form-control rating-select" data-user="${guesser.username}" style="flex: 1;">
                        <option value="0" ${rating === 0 ? 'selected' : ''}>0 Stars</option>
                        <option value="1" ${rating === 1 ? 'selected' : ''}>1 Star</option>
                        <option value="2" ${rating === 2 ? 'selected' : ''}>2 Stars</option>
                        <option value="3" ${rating === 3 ? 'selected' : ''}>3 Stars</option>
                        <option value="4" ${rating === 4 ? 'selected' : ''}>4 Stars</option>
                        <option value="5" ${rating === 5 ? 'selected' : ''}>5 Stars</option>
                    </select>
                    <button class="btn btn-small btn-info" onclick="updateRating('${guesser.username}')">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Add event listeners to rating selects
    document.querySelectorAll('.rating-select').forEach(select => {
        select.addEventListener('change', function() {
            const username = this.getAttribute('data-user');
            updateRating(username);
        });
    });
}

function updateRating(username) {
    const select = document.querySelector(`.rating-select[data-user="${username}"]`);
    const rating = parseInt(select.value);
    
    let users = JSON.parse(localStorage.getItem('matkaUsers') || '[]');
    const user = users.find(u => u.username === username);
    
    if (user) {
        user.rating = rating;
        localStorage.setItem('matkaUsers', JSON.stringify(users));
        
        showAlert(`Rating updated for ${username}: ${rating} stars`, 'success');
        logActivity(`Updated ${username} rating to ${rating} stars`);
    }
}

function calculateAllRatings() {
    if (!confirm('Calculate ratings for all guessers based on accuracy?')) return;
    
    const users = JSON.parse(localStorage.getItem('matkaUsers') || '[]');
    const predictions = JSON.parse(localStorage.getItem('matkaPredictions') || '[]');
    
    users.forEach(user => {
        if (user.type === 'guesser') {
            const guesserPredictions = predictions.filter(p => 
                p.guesserId === user.id || p.guesserId === user.username
            );
            
            const total = guesserPredictions.length;
            const correct = guesserPredictions.filter(p => p.isCorrect === true).length;
            const pending = guesserPredictions.filter(p => p.isCorrect === undefined).length;
            const checked = total - pending;
            const accuracy = checked > 0 ? Math.round((correct / checked) * 100) : 0;
            
            // Only calculate if user has at least 10 checked predictions
            if (checked >= 10) {
                if (accuracy >= 90) user.rating = 5;
                else if (accuracy >= 80) user.rating = 4;
                else if (accuracy >= 70) user.rating = 3;
                else if (accuracy >= 60) user.rating = 2;
                else user.rating = 1;
            }
        }
    });
    
    localStorage.setItem('matkaUsers', JSON.stringify(users));
    loadGuesserRatings();
    
    showAlert('All guesser ratings calculated successfully!', 'success');
    logActivity('Calculated ratings for all guessers');
}

function resetAllRatings() {
    if (!confirm('Reset all guesser ratings to 0?')) return;
    
    let users = JSON.parse(localStorage.getItem('matkaUsers') || '[]');
    users.forEach(user => {
        if (user.type === 'guesser') {
            user.rating = 0;
        }
    });
    
    localStorage.setItem('matkaUsers', JSON.stringify(users));
    loadGuesserRatings();
    
    showAlert('All ratings reset to 0', 'info');
    logActivity('Reset all guesser ratings');
}

// Add this function to show alerts
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        ${message}
    `;
    
    const container = document.querySelector('.dashboard-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Call loadGuesserRatings in your DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    loadGuesserRatings();
});
